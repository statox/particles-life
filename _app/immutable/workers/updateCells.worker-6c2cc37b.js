(function(){"use strict";const l=(t,n,s)=>{let e=Math.abs(s.x-n.x);e>t.x/2&&(e=t.x-e);let o=Math.abs(s.y-n.y);return o>t.y/2&&(o=t.y-o),e*e+o*o},p=(t,n,s,e,o)=>{const r=l(t,e.pos,o.pos),i=s*s;if(r>i)return 0;const x=(2*3)**2;if(r<x)return-1;const y=n[e.color][o.color]??0;return y===0?0:b(r,i/2,i,0,y)},b=function(t,n,s,e,o){const r=n+(s-n)/2;return t<r?q(t,n,r,e,o):q(t,r,s,o,e)},q=function(t,n,s,e,o){const r=(t-n)/(s-n)*(o-e)+e;return e<o?v(r,e,o):v(r,o,e)},v=function(t,n,s){return Math.max(Math.min(t,s),n)},I=(t,n)=>{const s=t.squareByCellId.get(n.id);if(!s)throw new Error("Cell not in map");const{x:e,y:o}=s,r=e===0?t.squares[0].length-1:e-1,i=e===t.squares[0].length-1?0:e+1,c=o===0?t.squares.length-1:o-1,x=o===t.squares.length-1?0:o+1,y=[{x:r,y:c},{x:e,y:c},{x:i,y:c},{x:r,y:o},{x:e,y:o},{x:i,y:o},{x:r,y:x},{x:e,y:x},{x:i,y:x}],a=[];for(const{x:f,y:u}of y)a.push(...t.squares[u][f]);return a},m=(t,n)=>{const s=Math.abs(n.x-t.x),e=Math.abs(n.y-t.y);return s*s+e*e};onmessage=t=>{const{minIndex:n,maxIndex:s,cells:e,cellsMap:o,worldSize:r,attractionTable:i}=t.data;for(let c=n;c<s;c++){const x=e[c];x.vel={x:0,y:0};const y=I(o,x);for(const f of y){if(c===f)continue;const u=e[f];let h=p(o.worldSize,i,o.maxAttractionRadius,x,u);m(x.pos,u.pos)>o.worldSize.y*o.worldSize.y/2&&(h*=-1);const d={x:u.pos.x-x.pos.x,y:u.pos.y-x.pos.y},g=Math.sqrt(d.x*d.x+d.y*d.y);if(g===0)continue;const P={x:d.x*(1/g),y:d.y*(1/g)},M={x:P.x*h,y:P.y*h};x.vel.x+=M.x,x.vel.y+=M.y}const a=Math.sqrt(x.vel.x*x.vel.x+x.vel.y*x.vel.y);a!==0&&(x.vel.x*=1/a,x.vel.y*=1/a,C(r,x))}postMessage({minIndex:n,maxIndex:s,cells:e})};const C=(t,n)=>{n.nextPos.x=n.pos.x+n.vel.x,n.nextPos.y=n.pos.y+n.vel.y,n.nextPos.x<=0?n.nextPos.x=t.x+n.nextPos.x:n.nextPos.x>=t.x&&(n.nextPos.x=n.nextPos.x-t.x),n.nextPos.y<=0?n.nextPos.y=t.y+n.nextPos.y:n.nextPos.y>=t.y&&(n.nextPos.y=n.nextPos.y-t.y)}})();
