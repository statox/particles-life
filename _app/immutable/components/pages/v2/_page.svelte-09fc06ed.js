import{S as B,i as F,s as W,k as b,w as z,a as x,q as E,l as C,m as v,x as q,c as k,r as P,h as d,b as _,y as T,D as w,u as H,f as I,t as M,z as A,K as N,I as O,B as K}from"../../../chunks/index-689c9b92.js";import{A as L}from"../../../chunks/AttractionTableChoice-fd543907.js";import{g as j,A as G}from"../../../chunks/AttractionTableComponent-d5de4049.js";import{_ as J}from"../../../chunks/preload-helper-41c905a7.js";import{P as Q}from"../../../chunks/P5-a2aedab4.js";class X{squares;squareByCellId;worldSize;maxAttractionRadius;constructor(t){const{worldSize:e,maxAttractionRadius:s}=t;if(e.x%s!==0||e.y%s!==0)throw new Error("Screen size is not a multiple of maxAttractionRadius");this.worldSize={...e},this.maxAttractionRadius=s,this.squareByCellId=new Map,this.squares=[];const a=s,i=e.x/a,c=e.y/a;for(let o=0;o<c;o++){this.squares.push([]);for(let l=0;l<i;l++)this.squares[o].push(new Set)}}checkCoord(t){if(t.x<0||t.x>this.worldSize.x||t.y<0||t.y>this.worldSize.y)throw new Error(`The cell at position ${t.x},${t.y} is outside of the screen ${this.worldSize.x},${this.worldSize.y} `)}getSquareCoords(t){return this.checkCoord(t),{x:Math.floor(t.x*this.squares[0].length/this.worldSize.x),y:Math.floor(t.y*this.squares.length/this.worldSize.y)}}insert(t){if(this.squareByCellId.get(t.id))throw new Error("Cell already in map");const e=this.getSquareCoords(t.pos);this.squares[e.y][e.x].add(t.id),this.squareByCellId.set(t.id,e)}updateCell(t){this.checkCoord(t.pos);const e=this.squareByCellId.get(t.id);if(!e)throw new Error("Cell not in map");this.squares[e.y][e.x].delete(t.id);const s=this.getSquareCoords(t.pos);this.squares[s.y][s.x].add(t.id),this.squareByCellId.set(t.id,s)}}const V=await J(()=>import("../../../chunks/updateCells.worker-6697127c.js"),[],import.meta.url),U=["white","red","green","blue"],Y=()=>{const n=Math.floor(Math.random()*U.length);return U[n]};class Z{_running;_stepInterval;_workers;_nbWorkers;_cellsMap;attractionTable;worldSize;cells;constructor(t){this._running=!1,this._stepInterval=void 0,this._nbWorkers=4,this._workers=[],this.worldSize={x:1600,y:960},this.cells=[],this.attractionTable=j(),this._cellsMap=new X({worldSize:this.worldSize,maxAttractionRadius:32});for(let e=0;e<t;e++){const s={id:e,pos:{x:Math.floor(Math.random()*this.worldSize.x),y:Math.floor(Math.random()*this.worldSize.y)},nextPos:{x:0,y:0},vel:{x:0,y:0},color:Y()};this.cells.push(s),this._cellsMap.insert(s)}}async run(){if(!V)throw new Error("UpdateCellsWorker is undefined");if(!this._workers.length){this._workers=[];for(let e=0;e<this._nbWorkers;e++)this._workers.push(new V.default)}this._running=!0;const t=()=>{this._running&&this.step(e=>{if(e)throw e;this._stepInterval=setTimeout(t,1)})};t()}pause(){this._running=!1,clearTimeout(this._stepInterval)}step(t){if(!this._workers.length)return t(new Error("_workers is undefined"));let e=0;const s=i=>{const{minIndex:c,maxIndex:o,cells:l}=i.data;for(let h=c;h<o;h++)this.cells[h].pos=l[h].nextPos,this._cellsMap.updateCell(this.cells[h]);if(e++,e===this._workers.length)return t()},a=Math.floor(this.cells.length/this._workers.length);for(let i=0;i<this._workers.length;i++){const c=this._workers[i];c.onmessage=s;const o=i*a,l=i===this._workers.length-1?this.cells.length-1:(i+1)*a-1;c.postMessage({minIndex:o,maxIndex:l,cells:this.cells,cellsMap:this._cellsMap,worldSize:this.worldSize,attractionTable:this.attractionTable})}}}const tt=(n,t,e)=>{n.noStroke();for(const s of t){n.fill(s.color);const a=n.map(s.pos.x,0,e.x,0,n.width),i=n.map(s.pos.y,0,e.y,0,n.height);n.circle(a,i,4)}};function et(n){let t,e,s,a,i,c,o;return e=new Q({props:{sketch:n[1]}}),{c(){t=b("div"),z(e.$$.fragment),s=x(),a=b("span"),i=E("FPS: "),c=E(n[0])},l(l){t=C(l,"DIV",{});var h=v(t);q(e.$$.fragment,h),s=k(h),a=C(h,"SPAN",{});var u=v(a);i=P(u,"FPS: "),c=P(u,n[0]),u.forEach(d),h.forEach(d)},m(l,h){_(l,t,h),T(e,t,null),w(t,s),w(t,a),w(a,i),w(a,c),o=!0},p(l,[h]){(!o||h&1)&&H(c,l[0])},i(l){o||(I(e.$$.fragment,l),o=!0)},o(l){M(e.$$.fragment,l),o=!1},d(l){l&&d(t),A(e)}}}function st(n,t,e){let s,{cells:a}=t,{worldSize:i}=t,c;const o=[],l=u=>{u.setup=()=>{s=u,u.createCanvas(1e3,700)},u.draw=()=>{u.background(0),tt(u,a,i),e(0,c=h(u))}},h=u=>(o.push(u.frameRate()),o.length>60&&o.shift(),o.reduce((g,m)=>g+m/o.length,0).toFixed(0));return N(()=>{s?.remove()}),n.$$set=u=>{"cells"in u&&e(2,a=u.cells),"worldSize"in u&&e(3,i=u.worldSize)},[c,l,a,i]}class rt extends B{constructor(t){super(),F(this,t,st,et,W,{cells:2,worldSize:3})}}function nt(n){let t,e,s,a,i,c,o,l=n[0]._running?"Pause":"Play",h,u,p,g,m,$,R,D;return a=new rt({props:{cells:n[0].cells,worldSize:n[0].worldSize}}),p=new L({props:{updateTable:n[1]}}),m=new G({props:{attractionTable:n[0].attractionTable,onUpdateTable:n[1]}}),{c(){t=b("h2"),e=E("V2 WIP"),s=x(),z(a.$$.fragment),i=x(),c=b("div"),o=b("button"),h=E(l),u=x(),z(p.$$.fragment),g=x(),z(m.$$.fragment)},l(r){t=C(r,"H2",{});var f=v(t);e=P(f,"V2 WIP"),f.forEach(d),s=k(r),q(a.$$.fragment,r),i=k(r),c=C(r,"DIV",{});var S=v(c);o=C(S,"BUTTON",{});var y=v(o);h=P(y,l),y.forEach(d),S.forEach(d),u=k(r),q(p.$$.fragment,r),g=k(r),q(m.$$.fragment,r)},m(r,f){_(r,t,f),w(t,e),_(r,s,f),T(a,r,f),_(r,i,f),_(r,c,f),w(c,o),w(o,h),_(r,u,f),T(p,r,f),_(r,g,f),T(m,r,f),$=!0,R||(D=O(o,"click",n[2]),R=!0)},p(r,[f]){const S={};f&1&&(S.cells=r[0].cells),f&1&&(S.worldSize=r[0].worldSize),a.$set(S),(!$||f&1)&&l!==(l=r[0]._running?"Pause":"Play")&&H(h,l);const y={};f&1&&(y.attractionTable=r[0].attractionTable),m.$set(y)},i(r){$||(I(a.$$.fragment,r),I(p.$$.fragment,r),I(m.$$.fragment,r),$=!0)},o(r){M(a.$$.fragment,r),M(p.$$.fragment,r),M(m.$$.fragment,r),$=!1},d(r){r&&d(t),r&&d(s),A(a,r),r&&d(i),r&&d(c),r&&d(u),A(p,r),r&&d(g),A(m,r),R=!1,D()}}}function at(n,t,e){const s=new Z(1e3);return[s,c=>{e(0,s.attractionTable=c,s)},()=>{s._running?s.pause():s.run(),e(0,s)}]}class it extends B{constructor(t){super(),F(this,t,at,nt,W,{})}}function ot(n){let t,e;return t=new it({}),{c(){z(t.$$.fragment)},l(s){q(t.$$.fragment,s)},m(s,a){T(t,s,a),e=!0},p:K,i(s){e||(I(t.$$.fragment,s),e=!0)},o(s){M(t.$$.fragment,s),e=!1},d(s){A(t,s)}}}class dt extends B{constructor(t){super(),F(this,t,null,ot,W,{})}}export{dt as default};
